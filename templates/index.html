<!doctype html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FjordLens</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <!-- App icons / PWA manifest -->
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='icons/fjordlens.svg') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/fjordlens_lens_favicon_32.png') }}">
  <link rel="icon" type="image/png" sizes="64x64" href="{{ url_for('static', filename='icons/fjordlens_lens_favicon_64.png') }}">
  <link rel="icon" type="image/png" sizes="128x128" href="{{ url_for('static', filename='icons/fjordlens_lens_favicon_128.png') }}">
  <link rel="icon" type="image/png" sizes="256x256" href="{{ url_for('static', filename='icons/fjordlens_lens_favicon_256.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/fjordlens_lens_appicon_256.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='icons/site.webmanifest') }}">
  <meta name="theme-color" content="#0f1115">
  <!-- MapLibre (for Steder-kort med clustering) -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="logo">
        <img class="logo-icon" src="{{ url_for('static', filename='icons/fjordlens_lens_favicon_32.png') }}" alt="FjordLens" />
        <div>
          <div class="logo-title">FjordLens</div>
          <div class="logo-sub">Synology Starter</div>
        </div>
      </div>

      <nav class="nav">
        <button class="nav-item active" data-view="timeline">üìÖ Tidlinje</button>
        <button class="nav-item" data-view="favorites">‚≠ê Favoritter</button>
        <button class="nav-item" data-view="steder">üìç Steder</button>
        <button class="nav-item" data-view="kameraer">üì∏ Kameraer</button>
        <button class="nav-item" data-view="mapper">üóÇÔ∏è Mapper</button>
        <div id="mapperNavMenu" class="mapper-nav-menu hidden">
          <div id="mapperTreeNav" class="mapper-tree hidden" aria-label="Mappe-navigation"></div>
        </div>
        <button class="nav-item" data-view="personer">üôÇ Personer</button>
        <button class="nav-item" data-view="settings">‚öôÔ∏è Indstillinger</button>
      </nav>

      <div class="sidebar-card">
        <div class="sidebar-card-title">AI-s√∏gning (klar til n√¶ste trin)</div>
        <p>Datafelter og API er gjort klar til ONNX/CLIP og ansigtsgenkendelse.</p>
        <p class="hint">Du kan allerede s√∏ge p√• dansk i metadata og placeholder-tags.</p>
      </div>


      <div class="sidebar-footer">
        <a href="#" id="profileLink" class="mini-link">Profil</a>
        <a href="/api/health" target="_blank" class="mini-link">API health</a>
        <a href="/api/filters" target="_blank" class="mini-link">Filtre</a>
        <!-- Flyttet ind under Indstillinger som faner -->
        <a href="/logout" class="mini-link">Log ud</a>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <button id="menuBtn" class="btn menu-btn" aria-label="Menu" title="Menu">‚ò∞</button>
        <div class="search-wrap">
          <input id="searchInput" type="text" placeholder="S√∏g p√• dansk: strand, bil, skov, kamera, dato, filnavn...">
        </div>
        <button id="aiToggle" class="btn" title="AI-s√∏gning">AI</button>
        <select id="sortSelect" class="select">
          <option value="date_desc">Nyeste f√∏rst</option>
          <option value="date_asc">√Üldste f√∏rst</option>
          <option value="name_asc">Navn A-√Ö</option>
          <option value="name_desc">Navn √Ö-A</option>
          <option value="size_desc">St√∏rst f√∏rst</option>
          <option value="size_asc">Mindst f√∏rst</option>
        </select>
      </header>

      <section class="content-header">
        <div>
          <h1 id="viewTitle">Bibliotek</h1>
          <p id="viewSubtitle">Scan din fotomappe og s√∏g/sort√©r i metadata</p>
        </div>
        <div class="stats">
          <div class="stat-card" id="statPhotos">
            <span class="stat-label" id="photoCountLabel">Billeder</span>
            <span class="stat-value" id="photoCount">0</span>
          </div>
          <div class="stat-card" id="statFavorites">
            <span class="stat-label" id="favoriteCountLabel">Favoritter</span>
            <span class="stat-value" id="favoriteCount">0</span>
          </div>
          <div class="stat-card" id="statSelected">
            <span class="stat-label" id="selectedCountLabel">Valgt</span>
            <span class="stat-value" id="selectedCount">0</span>
          </div>
          <div class="stat-card" id="statHiddenToggle" style="display:none;align-items:center;gap:10px;">
            <label class="stat-label" for="showHiddenToggle">Vis skjulte</label>
            <input id="showHiddenToggle" class="switch" type="checkbox" />
          </div>
        </div>
      </section>

      <section id="mapperTools" class="mapper-tools hidden">
        <div class="mapper-tools-row">
          <span id="mapperCurrentPath" class="mini-label">Aktuel mappe: uploads</span>
          <button id="mapperUpBtn" class="btn">Op</button>
          <button id="mapperEditBtn" class="btn">!edit</button>
          <button id="mapperDeleteBtn" class="btn danger hidden" disabled>Slet valgte</button>
          <input id="mapperFolderNewInput" class="mapper-input" type="text" placeholder="Ny mappe (fx 2026/rejse)" />
          <button id="mapperFolderCreateBtn" class="btn">Opret mappe</button>
        </div>
        <div id="mapperDropZone" class="mapper-dropzone">Slip filer her for at uploade direkte til valgt mappe</div>
      </section>

      <section id="statusBar" class="status hidden"></section>
      <section id="emptyState" class="empty hidden"></section>
      <section id="galleryGrid" class="gallery-grid"></section>

      <!-- Steder: interaktivt kort med clustering -->
      <section id="placesMapWrap" class="hidden" style="position:relative;">
        <div id="placesMap" style="width:100%;height:68vh;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0d1016;"></div>
        <div id="placesBanner" style="position:absolute;right:10px;top:10px;z-index:3;padding:6px 10px;border:1px solid var(--border);background:rgba(15,17,21,0.9);border-radius:8px;color:var(--muted);font-size:0.85rem;display:none;"></div>
        <!-- Cluster bottom sheet overlays inside map area -->
        <div id="clusterSheet" class="sheet hidden" style="z-index:3;">
          <div class="sheet-bar"></div>
          <div class="sheet-content">
            <div class="sheet-grid" id="clusterGrid"></div>
          </div>
        </div>
      </section>

      

      <!-- Indstillinger panel -->
      <section id="settingsPanel" class="hidden">
        <div class="settings-header">
          <h1>Indstillinger</h1>
          <p>Vedligeholdelse, scan og logs</p>
        </div>
        <nav class="tabs">
          <button class="tab-btn active" data-tab="maint">Vedligeholdelse</button>
          <button class="tab-btn" data-tab="ai">AI</button>
          <button class="tab-btn" data-tab="logs">Logs</button>
          <button class="tab-btn" data-tab="users">Brugere</button>
          <button class="tab-btn" data-tab="twofa">Min 2FA</button>
          <button class="tab-btn" data-tab="other">Andet</button>
        </nav>

        <!-- Vedligeholdelse -->
        <div class="tab-panel" data-tabpanel="maint">
          <div class="sidebar-card" style="margin-bottom:12px;">
            <div class="sidebar-card-title">Vedligeholdelse</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button id="scanBtn" class="btn primary">Scan bibliotek</button>
              <button id="rescanBtn" class="btn">Rescan metadata</button>
              <button id="rethumbBtn" class="btn">Genbyg thumbnails</button>
              <button id="clearIndexBtn" class="btn danger">Nulstil indeks</button>
            </div>
          </div>
        </div>

        <!-- AI -->
        <div class="tab-panel hidden" data-tabpanel="ai">
          <div class="sidebar-card" style="margin-bottom:12px;">
            <div id="aiPanelTitle" class="sidebar-card-title">AI</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
              <div style="border:1px solid var(--border); border-radius:10px; padding:10px;">
                <div id="aiEmbedTitle" class="mini-label" style="font-weight:700; margin-bottom:6px;">AI-embeddings</div>
                <p id="aiEmbedDesc" class="hint" style="margin:0 0 8px 0;">Starter/stopper embedding-job for billeder uden embedding.</p>
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:6px;">
                  <label class="ai-toggle-row" for="aiIngestToggle">
                    <input id="aiIngestToggle" class="ai-toggle-input" type="checkbox" role="switch" aria-label="AI embeddings toggle" />
                    <span class="ai-toggle-slider" aria-hidden="true"></span>
                    <span id="aiIngestToggleText" class="mini-label">Start AI</span>
                  </label>
                </div>
                <div id="aiStatus" class="mini-label">AI: ‚Äî</div>
              </div>

              <div style="border:1px solid var(--border); border-radius:10px; padding:10px;">
                <div id="aiFacesTitle" class="mini-label" style="font-weight:700; margin-bottom:6px;">Ansigtsindeksering</div>
                <p id="aiFacesDesc" class="hint" style="margin:0 0 8px 0;">Scanner billeder for ansigter og opdaterer persondata.</p>
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:6px;">
                  <label class="ai-toggle-row" for="facesToggle">
                    <input id="facesToggle" class="ai-toggle-input" type="checkbox" role="switch" aria-label="Face indexing toggle" />
                    <span class="ai-toggle-slider" aria-hidden="true"></span>
                    <span id="facesToggleText" class="mini-label">Start ansigter</span>
                  </label>
                </div>
                <div id="facesStatus" class="mini-label">Ansigter: ‚Äî</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Andet (dupletter) -->
        <div class="tab-panel hidden" data-tabpanel="other">
          <div class="sidebar-card" id="dupeCard" style="margin-bottom:12px;">
            <div class="sidebar-card-title" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
              <span>Dupletter</span>
              <label class="mini-label" for="dupeDist">Afstand</label>
              <input id="dupeDist" type="number" min="0" max="20" value="5" class="input-number small" />
              <label class="mini-label" for="dupeMin">Min gruppe</label>
              <input id="dupeMin" type="number" min="2" max="10" value="2" class="input-number small" />
              <button id="dupesRun" class="btn">Scan</button>
            </div>
            <section id="dupeStatus" class="status hidden"></section>
            <div id="dupeResults" class="dupe-groups"></div>
          </div>
        </div>

        <!-- Logs -->
        <div class="tab-panel hidden" data-tabpanel="logs" id="logsPanel">
          <div class="status" style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
            <strong>Logs:</strong>
            <button id="logsStart" class="btn">Stop</button>
            <button id="mainLogsClear" class="btn">Ryd</button>
          </div>
          <pre id="mainLogs" class="raw-meta" style="height:60vh;"></pre>
        </div>

        <!-- Brugere (indlejret UI via JSON, ingen iframes) -->
        <div class="tab-panel hidden" data-tabpanel="users">
          <div class="sidebar-card" style="margin-bottom:12px;">
            <div class="sidebar-card-title">Brugere</div>
            <div id="usersPanelInner">Indl√¶ser‚Ä¶</div>
          </div>
        </div>

        <!-- Min 2FA (indlejret UI via JSON) -->
        <div class="tab-panel hidden" data-tabpanel="twofa">
          <div class="sidebar-card" style="margin-bottom:12px;">
            <div class="sidebar-card-title">Min 2FA</div>
            <div id="twofaPanelInner">Indl√¶ser‚Ä¶</div>
          </div>
        </div>

      </section>
    </main>

    <aside class="detail-panel">
      <div id="detailEmpty" class="detail-empty">
        <p>V√¶lg et billede for at se detaljer og metadata.</p>
      </div>

      <div id="detailContent" class="detail-content hidden">
        <div class="detail-thumb-wrap">
          <img id="detailThumb" alt="Thumbnail">
        </div>

        <div class="detail-header">
          <h3 id="detailName">-</h3>
        </div>
        <div class="detail-actions">
          <button id="favoriteBtn" class="icon-btn" title="Favorit">‚òÜ</button>
          <button id="similarBtn" class="btn" title="Find lignende">Lignende</button>
        </div>

        <div class="detail-path" id="detailPath">-</div>

        <div class="detail-list">
          <div class="detail-row"><span>Dato</span>
            <div class="detail-val">
              <strong id="detailDate">-</strong>
              <button id="editDateBtn" class="icon-btn tiny" title="Rediger dato">‚úé</button>
            </div>
            <div id="dateEditWrap" class="date-popover hidden">
              <div style="display:flex; gap:6px; align-items:center;">
                <input id="dateInput" type="datetime-local" class="input-number" style="flex:1; min-width: 220px;" />
                <button id="dateSaveBtn" class="btn small primary">Gem</button>
                <button id="dateCancelBtn" class="btn small">Luk</button>
              </div>
            </div>
          </div>
          <div class="detail-row"><span>St√∏rrelse</span><strong id="detailSize">-</strong></div>
          <div class="detail-row"><span>Dimensioner</span><strong id="detailDims">-</strong></div>
          <div class="detail-row"><span>Enhed</span><strong id="detailDevice">-</strong></div>
          <div class="detail-row"><span>Linse</span><strong id="detailLens">-</strong></div>
          <div class="detail-row"><span>GPS</span>
            <div class="detail-val">
              <strong id="detailGps">-</strong>
              <button id="editGpsBtn" class="icon-btn tiny" title="Rediger GPS">‚úé</button>
            </div>
            <div id="gpsEditWrap" class="gps-modal hidden">
              <div class="gps-search">
                <input id="gpsSearchInput" type="text" placeholder="S√∏g adresse‚Ä¶" />
                <div id="gpsSearchList" class="gps-results hidden"></div>
              </div>
              <div id="gpsMap" class="gps-map"></div>
              <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">
                <div id="gpsCoordText" class="mini-label">Klik p√• kortet for at v√¶lge</div>
                <div>
                  <button id="gpsSaveBtn" class="btn small primary">Gem</button>
                  <button id="gpsCancelBtn" class="btn small">Luk</button>
                </div>
              </div>
            </div>
          </div>
            <div class="detail-row"><span>Land</span><strong id="detailCountry">-</strong></div>
            <div class="detail-row"><span>By</span><strong id="detailCity">-</strong></div>
          <div class="detail-row"><span>AI tags</span><strong id="detailAiTags">-</strong></div>
        </div>

        <div class="accordion">
          <button id="toggleRawBtn" class="btn ghost full">Vis r√• metadata (JSON)</button>
          <pre id="rawMeta" class="raw-meta hidden"></pre>
        </div>
      </div>
    </aside>
  </div>

  <!-- Media viewer modal -->
  <div id="viewer" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <button id="viewerPrev" class="btn" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);">‚ü®</button>
    <img id="viewerImg" alt="" style="max-width:92vw;max-height:90vh;border-radius:12px;border:1px solid rgba(255,255,255,0.2);display:none;" />
    <video id="viewerVideo" controls style="max-width:92vw;max-height:90vh;border-radius:12px;border:1px solid rgba(255,255,255,0.2);display:none;"></video>
    <button id="viewerNext" class="btn" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);">‚ü©</button>
    <button id="viewerClose" class="btn" style="position:absolute;right:12px;top:12px;">Luk</button>
    <button id="viewerInfoBtn" class="btn" title="Vis info" style="position:absolute;right:12px;top:54px;">Info</button>
    <a id="viewerOpenOrig" class="btn" target="_blank" rel="noopener" style="position:absolute;left:12px;top:12px;">√Öbn original</a>
    <!-- Slide-out info panel inside viewer -->
    <aside id="viewerInfo" class="viewer-info hidden">
      <div class="detail-panel viewer-info-inner">
        <h3 id="viTitle" style="margin:0 0 6px;">‚Äî</h3>
        <div class="vi-actions" style="margin:6px 0 10px;display:flex;gap:8px;align-items:center;">
          <button id="viFavoriteBtn" class="icon-btn" title="Favorit">‚òÜ</button>
          <button id="viSimilarBtn" class="btn" title="Find lignende">Lignende</button>
        </div>
        <div class="detail-list">
          <div class="detail-row"><span>Dato</span>
            <div class="detail-val">
              <strong id="viDate">‚Äî</strong>
              <button id="viEditDateBtn" class="icon-btn tiny" title="Rediger dato">‚úé</button>
            </div>
          </div>
          <div class="detail-row"><span>St√∏rrelse</span><strong id="viSize">‚Äî</strong></div>
          <div class="detail-row"><span>Dimensioner</span><strong id="viDims">‚Äî</strong></div>
          <div class="detail-row"><span>Enhed</span><strong id="viDevice">‚Äî</strong></div>
          <div class="detail-row"><span>Linse</span><strong id="viLens">‚Äî</strong></div>
          <div class="detail-row"><span>GPS</span>
            <div class="detail-val">
              <strong id="viGps">‚Äî</strong>
              <button id="viEditGpsBtn" class="icon-btn tiny" title="Rediger GPS">‚úé</button>
            </div>
          </div>
          <div class="detail-row"><span>Land</span><strong id="viCountry">‚Äî</strong></div>
          <div class="detail-row"><span>By</span><strong id="viCity">‚Äî</strong></div>
          <div class="detail-row"><span>AI tags</span><strong id="viTags">‚Äî</strong></div>
        </div>
        <div class="vi-actions" style="margin-top:10px;display:flex;gap:8px;">
          <a id="viDownload" class="btn" href="#" target="_blank" rel="noopener">Download</a>
        </div>
      </div>
    </aside>
  </div>
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <div id="profileModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;">
    <div style="width:620px;max-width:92vw;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h3 style="margin:0;">Profil</h3>
        <button id="profileModalClose" class="btn">Luk</button>
      </div>
      <div id="profilePanelInner">Indl√¶ser‚Ä¶</div>
    </div>
  </div>
  <div id="scanModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;">
    <div style="width:520px;max-width:92vw;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h3 id="scanModalTitle" style="margin:0;">Scan bibliotek</h3>
        <button id="scanModalClose" class="btn">Luk</button>
      </div>
      <p id="scanModalText" class="mini-label" style="margin:0 0 14px;line-height:1.5;">Vil du starte en fuld scanning af biblioteket nu?</p>
      <div class="actions" style="justify-content:flex-end;gap:8px;">
        <button id="scanModalCancel" class="btn">Annuller</button>
        <button id="scanModalStart" class="btn primary">Start scan</button>
      </div>
    </div>
  </div>
  <div id="aiScopeModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;">
    <div style="width:560px;max-width:92vw;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h3 id="aiScopeModalTitle" style="margin:0;">Start processing</h3>
        <button id="aiScopeModalClose" class="btn">Luk</button>
      </div>
      <p id="aiScopeModalText" class="mini-label" style="margin:0 0 14px;line-height:1.5;">Do you want to process all existing items, or only new uploads from now on?</p>
      <div class="actions" style="justify-content:flex-end;gap:8px;">
        <button id="aiScopeModalCancel" class="btn">Annuller</button>
        <button id="aiScopeModalNew" class="btn">Kun nye uploads</button>
        <button id="aiScopeModalAll" class="btn primary">Alle eksisterende</button>
      </div>
    </div>
  </div>
  <script>
    window.APP_PROFILE = {{ (user_profile or {})|tojson }};
    window.APP_ROLE = {{ (user_role or 'user')|tojson }};
  </script>
  <script src="{{ url_for('static', filename='app.js') }}"></script>
  <!-- Drag & Drop Upload Overlay -->
  <div id="uploadOverlay" class="upload-overlay hidden">
    <div class="upload-box">
      <div class="upload-title">Tr√¶k filer herind for at uploade</div>
      <div class="upload-progress"><div id="uploadProgressBar" class="bar"></div></div>
      <div id="uploadProgressText" class="upload-text"></div>
    </div>
  </div>
  <script>
    (function(){
      const ROLE = window.APP_ROLE || 'user';
      // Hide Settings tabs based on role
      function hideTab(tab){
        const btn = document.querySelector(`#settingsPanel .tab-btn[data-tab="${tab}"]`);
        const panel = document.querySelector(`#settingsPanel .tab-panel[data-tabpanel="${tab}"]`);
        if(btn) btn.style.display = 'none';
        if(panel) panel.parentElement && panel.parentElement.removeChild(panel);
      }
      if(ROLE === 'user'){
        hideTab('users');
        hideTab('other');
        hideTab('maint');
        hideTab('logs');
      } else if(ROLE === 'manager'){
        hideTab('users');
      }
      // Ensure one visible tab is active
      const activeBtn = document.querySelector('#settingsPanel .tab-btn.active');
      if (!activeBtn || activeBtn.style.display === 'none'){
        const firstVisible = Array.from(document.querySelectorAll('#settingsPanel .tab-btn')).find(b => b.style.display !== 'none');
        if (firstVisible) {
          firstVisible.click();
        }
      }
    })();
  </script>
</body>
</html>
