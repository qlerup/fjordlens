<!doctype html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>2FA · FjordLens</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body style="display:grid;min-height:100vh;place-items:center;">
  <div class="login-card" style="width:420px;max-width:92vw;border:1px solid var(--border);background:var(--panel);border-radius:12px;padding:16px;">
    <h2 style="margin:0 0 10px;">To-faktor godkendelse</h2>
    {% if enabled %}
      <p>2FA er aktiveret for din konto.</p>
      {% if error %}<div class="status err" style="margin-bottom:8px;">{{ error }}</div>{% endif %}
      {% if ok %}<div class="status ok" style="margin-bottom:8px;">Indstillinger gemt.</div>{% endif %}
      <form id="twofaForm" method="post" style="margin:10px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input type="hidden" name="action" value="save">
        <input type="hidden" name="code" id="hiddenCode">
        <label for="remember_days" class="mini-label">Husk denne enhed</label>
        <select id="remember_days" name="days" class="select">
          <option value="0" {% if (remember_days or 0) == 0 %}selected{% endif %}>Hver gang</option>
          <option value="1" {% if (remember_days or 0) == 1 %}selected{% endif %}>1 dag</option>
          <option value="3" {% if (remember_days or 0) == 3 %}selected{% endif %}>3 dage</option>
          <option value="5" {% if (remember_days or 0) == 5 %}selected{% endif %}>5 dage</option>
          <option value="7" {% if (remember_days or 0) == 7 %}selected{% endif %}>7 dage</option>
        </select>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" name="disable" />
          <span>Deaktivér 2FA</span>
        </label>
        <button class="btn" type="submit">Gem</button>
      </form>
      <!-- 2FA code modal -->
      <div id="codeModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="width:360px;max-width:92vw;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 style="margin:0;">Bekræft med 2FA</h3>
            <button id="codeCancel" class="btn">Luk</button>
          </div>
          <p class="mini-label" style="margin:0 0 8px;">Indtast 6‑cifret 2FA‑kode for at gemme ændringerne</p>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="codeInput" class="input-number" style="flex:1;" inputmode="numeric" pattern="\d{6}" maxlength="6" placeholder="2FA kode"/>
            <button id="codeOk" class="btn primary">Bekræft</button>
          </div>
        </div>
      </div>
    {% else %}
      <p>Scan QR-koden i din Authenticator-app, og indtast koden for at aktivere.</p>
      <div style="display:grid;place-items:center;margin:10px 0;">
        <img src="{{ qrcode_url }}" alt="QR" style="width:220px;height:220px;border-radius:12px;border:1px solid var(--border);background:#fff;"/>
      </div>
      <p style="color:var(--muted);word-break:break-all;">Secret: {{ secret }}</p>
      {% if error %}<div class="err">{{ error }}</div>{% endif %}
      {% if ok %}<div class="status ok">2FA er nu slået til.</div>{% endif %}
      <form id="setupForm" method="post" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <input id="setupCode" name="code" placeholder="6-cifret kode" required class="input-number" style="flex:1;" inputmode="numeric" pattern="\d{6}" maxlength="6" autocomplete="one-time-code"/>
        <label for="remember_days_on_enable" class="mini-label">Husk i</label>
        <select id="remember_days_on_enable" name="days" class="select">
          <option value="0">Hver gang</option>
          <option value="1">1 dag</option>
          <option value="3">3 dage</option>
          <option value="5">5 dage</option>
          <option value="7">7 dage</option>
        </select>
        <button class="btn primary">Aktivér</button>
      </form>
    {% endif %}
    <div style="margin-top:10px;display:flex;justify-content:flex-start;align-items:center;gap:8px;">
      <a class="btn" href="/" target="_top" rel="noopener">Luk</a>
    </div>
  </div>
  <script>
    (function(){
      // Auto-submit on new code during initial enable
      const input = document.getElementById('setupCode');
      const form = document.getElementById('setupForm');
      if (!input || !form) return;
      input.addEventListener('input', () => {
        const v = (input.value || '').replace(/\D/g, '').slice(0,6);
        if (v !== input.value) input.value = v;
        if (v.length === 6) {
          try { form.requestSubmit ? form.requestSubmit() : form.submit(); } catch(e) { form.submit(); }
        }
      });
    })();
  </script>
  <script>
    (function(){
      // Modal flow for saving settings when 2FA is enabled
      const frm = document.getElementById('twofaForm');
      if (!frm) return;
      const remember = document.getElementById('remember_days');
      const hiddenCode = document.getElementById('hiddenCode');
      const codeModal = document.getElementById('codeModal');
      const codeInput = document.getElementById('codeInput');
      const codeOk = document.getElementById('codeOk');
      const codeCancel = document.getElementById('codeCancel');
      // Values from server to decide if we need code
      const initialDays = Number({{ (remember_days or 0) }});
      const initialEnabled = true; // this template branch renders only when enabled

      function needsCode() {
        const disable = !!frm.querySelector('input[name="disable"]').checked;
        const days = Number(remember ? remember.value : 0);
        return initialEnabled && (disable || days !== initialDays);
      }
      function showModal(){ if (codeModal) { codeModal.classList.remove('hidden'); setTimeout(()=>{ try{ codeInput.focus(); }catch(_){} }, 10);} }
      function hideModal(){ if (codeModal) codeModal.classList.add('hidden'); }

      frm.addEventListener('submit', (e) => {
        if (needsCode() && (!hiddenCode.value || hiddenCode.value.length !== 6)) {
          e.preventDefault();
          hiddenCode.value = '';
          if (codeInput) codeInput.value = '';
          showModal();
        }
      });
      codeOk && codeOk.addEventListener('click', (e) => {
        e.preventDefault();
        const v = (codeInput.value || '').replace(/\D/g, '').slice(0,6);
        if (v.length !== 6) { codeInput.focus(); return; }
        hiddenCode.value = v;
        hideModal();
        try { frm.requestSubmit ? frm.requestSubmit() : frm.submit(); } catch(err) { frm.submit(); }
      });
      codeCancel && codeCancel.addEventListener('click', (e) => { e.preventDefault(); hideModal(); });
      codeModal && codeModal.addEventListener('click', (e) => { if (e.target === codeModal) hideModal(); });
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideModal(); });
    })();
  </script>
</body>
</html>
